<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        text {
            font-size: 16px;
            font-family: Open Sans, sans-serif;
        }
        
        text.title {
            font-size: 24px;
            font-weight: 500;
        }
        
        text.subTitle {
            font-weight: 500;
            fill: #777777;
        }
        
        text.caption {
            font-weight: 400;
            font-size: 14px;
            fill: #777777;
        }
        
        text.label {
            font-weight: 600;
        }
        
        text.valueLabel {
            font-weight: 300;
        }
        
        text.dateText {
            font-size: 64px;
            font-weight: 700;
            opacity: 0.25;
        }
        
        .tick text {
            fill: #777777;
        }
        
        .xAxis .tick:nth-child(2) text {
            text-anchor: start;
        }
        
        .tick line {
            shape-rendering: CrispEdges;
            stroke: #dddddd;
        }
        
        .tick line.origin {
            stroke: #aaaaaa;
        }
        
        path.domain {
            display: none;
        }
    </style>
</head>

<body>
    <script>
        // Feel free to change or delete any of the code you see in this editor!
        var svg = d3.select("body").append("svg")
            .attr("width", 960)
            .attr("height", 600);



        var tickDuration = 500;

        var top_n = 12;
        var height = 600;
        var width = 960;

        const margin = {
            top: 80,
            right: 0,
            bottom: 5,
            left: 0
        };
        var parseTime = d3.timeParse("%Y-%d-%m");

        let barPadding = (height - (margin.bottom + margin.top)) / (top_n * 5);

        let title = svg.append('text')
            .attr('class', 'title')
            .attr('y', 24)
            .html('Tests per confirmed cases');

        let subTitle = svg.append("text")
            .attr("class", "subTitle")
            .attr("y", 55)
            .html("Tests Per Case");

        let caption = svg.append('text')
            .attr('class', 'caption')
            .attr('x', width)
            .attr('y', height - 5)
            .style('text-anchor', 'end')
            .html('Source: Our World In Data');

        let date = 1 / 23 /
            2020;

        d3.csv("https://raw.githubusercontent.com/sumusa/Data-Visualization-Course/master/Project/covid-data.csv").then(function(data) {
            //if (error) throw error;

            console.log(data);

            data.forEach(d => {
                d.total_cases_per_million = +d.total_cases_per_million,
                    d.last_value = +d.last_value,
                    d.total_cases_per_million = isNaN(d.total_cases_per_million) ? 0 : d.total_cases_per_million,
                    d.date = parseTime(+d.date),
                    d.colour = d3.hsl(Math.random() * 360, 0.75, 0.75)
            });

            console.log(data);

            let dateSlice = data.filter(d => d.date == date && !isNaN(d.total_cases_per_million))
                .sort((a, b) => b.total_cases_per_million - a.total_cases_per_million)
                .slice(0, top_n);

            dateSlice.forEach((d, i) => d.rank = i);

            console.log('dateSlice: ', dateSlice)

            let x = d3.scaleTime()
                .domain([0, d3.max(dateSlice, d => d.total_cases_per_million)])
                .range([0, width - margin.left, width - margin.right - 65]);

            let y = d3.scaleLinear()
                .domain([top_n, 0])
                .range([height - margin.bottom, margin.top]);

            let xAxis = d3.axisTop()
                .scale(x)
                .ticks(width > 500 ? 5 : 2)
                .tickSize(-(height - margin.top - margin.bottom))
                .tickFormat(d => d3.format(',')(d));

            svg.append('g')
                .attr('class', 'axis xAxis')
                .attr('transform', `translate(0, ${margin.top})`)
                .call(xAxis)
                .selectAll('.tick line')
                .classed('origin', d => d == 0);

            svg.selectAll('rect.bar')
                .data(dateSlice, d => d.location)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', x(0) + 1)
                .attr('width', d => x(d.total_cases_per_million) - x(0) - 1)
                .attr('y', d => y(d.rank) + 5)
                .attr('height', y(1) - y(0) - barPadding)
                .style('fill', d => d.colour);

            svg.selectAll('text.label')
                .data(dateSlice, d => d.location)
                .enter()
                .append('text')
                .attr('class', 'label')
                .attr('x', d => x(d.total_cases_per_million) - 8)
                .attr('y', d => y(d.rank) + 5 + ((y(1) - y(0)) / 2) + 1)
                .style('text-anchor', 'end')
                .html(d => d.location);  
            svg.selectAll('text.valueLabel')
                .data(dateSlice, d => d.location)
                .enter()
                .append('text')
                .attr('class', 'valueLabel')
                .attr('x', d => x(d.total_cases_per_million) + 5)
                .attr('y', d => y(d.rank) + 5 + ((y(1) - y(0)) / 2) + 1)
                .text(d => d3.format(',.0f')(d.last_value));

            let yearText = svg.append('text')
                .attr('class', 'dateText')
                .attr('x', width - margin.right)
                .attr('y', height - 25)
                .style('text-anchor', 'end')
                .html(~~date)
                .call(halo, 10);

            let ticker = d3.interval(e => {

                dateSlice = data.filter(d => d.date == date && !isNaN(d.total_cases_per_million))
                    .sort((a, b) => b.total_cases_per_million - a.total_cases_per_million)
                    .slice(0, top_n);

                // dateSlice.forEach((d, i) => d.rank = i);

                //console.log('IntervalYear: ', yearSlice);

                x.domain([0, d3.max(dateSlice, d => d.total_cases_per_million)]);

                svg.select('.xAxis')
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .call(xAxis);

                let bars = svg.selectAll('.bar').data(dateSlice, d => d.location);

                bars
                    .enter()
                    .append('rect')
                    .attr('class', d => `bar ${d.location.replace(/\s/g,'_')}`)
                    .attr('x', x(0) + 1)
                    .attr('width', d => x(d.total_cases_per_million) - x(0) - 1)
                    .attr('y', d => y(top_n + 1) + 5)
                    .attr('height', y(1) - y(0) - barPadding)
                    .style('fill', d => d.colour)
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('y', d => y(d.rank) + 5);

                bars
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('width', d => x(d.total_cases_per_million) - x(0) - 1)
                    // .attr('y', d => y(d.rank) + 5);

                bars
                    .exit()
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('width', d => x(d.total) - x(0) - 1)
                    .attr('y', d => y(top_n + 1) + 5)
                    .remove();

                let labels = svg.selectAll('.label')
                    .data(dateSlice, d => d.location);

                labels
                    .enter()
                    .append('text')
                    .attr('class', 'label')
                    .attr('x', d => x(d.total_cases_per_million) - 8)
                    .attr('y', d => y(top_n + 1) + 5 + ((y(1) - y(0)) / 2))
                    .style('text-anchor', 'end')
                    .html(d => d.location)
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('y', d => y(d.rank) + 5 + ((y(1) - y(0)) / 2) + 1);


                labels
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('x', d => x(d.total_cases_per_million) - 8)
                    .attr('y', d => y(d.rank) + 5 + ((y(1) - y(0)) / 2) + 1);

                labels
                    .exit()
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('x', d => x(d.total_cases_per_million) - 8)
                    .attr('y', d => y(top_n + 1) + 5)
                    .remove();



                let valueLabels = svg.selectAll('.valueLabel').data(dateSlice, d => d.location);

                valueLabels
                    .enter()
                    .append('text')
                    .attr('class', 'valueLabel')
                    .attr('x', d => x(d.total_cases_per_million) + 5)
                    .attr('y', d => y(top_n + 1) + 5)
                    .text(d => d3.format(',.0f')(d.last_value))
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('y', d => y(d.rank) + 5 + ((y(1) - y(0)) / 2) + 1);

                valueLabels
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('x', d => x(d.total_cases_per_million) + 5)
                    // .attr('y', d => y(d.rank) + 5 + ((y(1) - y(0)) / 2) + 1)
                    .tween("text", function(d) {
                        let i = d3.interpolateRound(d.last_value, d.total_cases_per_million);
                        return function(t) {
                            this.textContent = d3.format(',')(i(t));
                        };
                    });


                valueLabels
                    .exit()
                    .transition()
                    .duration(tickDuration)
                    .ease(d3.easeLinear)
                    .attr('x', d => x(d.total_cases_per_million) + 5)
                    .attr('y', d => y(top_n + 1) + 5)
                    .remove();

                yearText.html(~~date);

                if (date == 11 / 30 / 2020) ticker.stop();
                date = d3.format('.1f')((+date) + 0.1);
            }, tickDuration);

        });

        const halo = function(text, strokeWidth) {
            text.select(function() {
                    return this.parentNode.insertBefore(this.cloneNode(true), this);
                })
                .style('fill', '#ffffff')
                .style('stroke', '#ffffff')
                .style('stroke-width', strokeWidth)
                .style('stroke-linejoin', 'round')
                .style('opacity', 1);

        }
    </script>
</body>